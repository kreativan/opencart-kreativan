<?xml version="1.0" encoding="utf-8"?>
<modification>
<name>Modification Default</name>
<code>default</code>
<version>1.1</version>
<author>OpenCart Ltd</author>
<link>http://www.opencart.com</link>

<file path="system/{engine,library}/{action,loader,config,language}*.php|system/library/template/template.php">
  <operation>
    <search regex="true">
      <![CDATA[~(require|include)(_once)?\(([^)]+)~]]>
    </search>
    <add position="replace">
      <![CDATA[$1$2(modification($3)]]>
    </add>
  </operation>
</file>

<!-- add kreativan menu on sidebar -->
<file path="admin/controller/common/column_left.php">
  <operation>
    <search><![CDATA[ $catalog = array(); ]]></search>
      <add position="before"><![CDATA[
          $kreativan = array();
          // Items
          $kreativan[] = array(
            'name'	   => 'Settings',
            'href'     => $this->url->link('kreativan/settings', 'user_token=' . $this->session->data['user_token'], true),
            'children' => array()
          );
          $kreativan[] = array(
            'name'	   => 'Theme',
            'href'     => $this->url->link('extension/theme/kreativan', 'user_token=' . $this->session->data['user_token'] . '&store_id=0', true),
            'children' => array()
          );
          $kreativan[] = array(
            'name'	   => 'Hero',
            'href'     => $this->url->link('kreativan/hero', 'user_token=' . $this->session->data['user_token'], true),
            'children' => array()
          );
          $kreativan[] = array(
            'name'	   => 'Homepage Layout',
            'href'     => $this->url->link('design/layout/edit', 'user_token=' . $this->session->data['user_token'] . '&layout_id=1', true),
            'children' => array()
          );
          // get module from db and create shortcut
          $kreativan_module_db = $this->db->query("SELECT * FROM `" . DB_PREFIX . "module` WHERE `code` = 'kreativan' ORDER BY `name`");
          if($kreativan_module_db->num_rows > 0) {
            $kreativan_module_id = $kreativan_module_db->row['module_id'];
            $kreativan[] = array(
              'name'	   => 'Custom Module',
              'href'     => $this->url->link('extension/module/kreativan', 'user_token=' . $this->session->data['user_token'] . '&module_id=' . $kreativan_module_id, true),
              'children' => array()
            );
          }
          $kreativan[] = array(
            'name'	   => 'Modules',
            'href'     => $this->url->link('marketplace/extension', 'user_token=' . $this->session->data['user_token'] . '&type=module', true),
            'children' => array()
          );
          $data['menus'][] = array(
            'id'       => 'kreativan-menu',
            'icon'	   => 'fa-html5',
            'name'	   => 'Kreativan',
            'href'     => '',
            'children' => $kreativan
          );
      ]]>
    </add>
  </operation>
</file>

<!-- header controller -->
<file path="catalog/controller/common/header.php">
  <operation>
    <search><![CDATA[ return $this->load->view('common/header', $data); ]]></search>
    <add position="before"><![CDATA[

        $legacy_array = [
          "checkout/checkout", 
          "affiliate/register",
          "account/edit",
          "account/address/edit",
          "account/affiliate/add",
          "account/register",
        ];

        $flatpickr_array = [
          "product/product",
          "account/return/add",
          "affiliate/register",
          "account/edit",
        ];

        $data['legacy'] = isset($_GET["route"]) && in_array($_GET["route"], $legacy_array) ? true : false;
        $data['theme'] = $this->config->get('config_theme');
        $data['headerbar'] = $this->load->controller('kreativan/headerbar');
        $data['navbar'] = $this->load->controller('kreativan/navbar');
        $data['less'] = $this->load->controller('kreativan/less');
        $data['flatpickr'] = isset($_GET["route"]) && in_array($_GET["route"], $flatpickr_array) ? true : false;
        $data['kreativan_jquery'] = $this->config->get('kreativan_jquery');
        
      ]]>
    </add>
  </operation>
</file>

<!-- footer controller -->
<file path="catalog/controller/common/footer.php">
  <operation>
    <search><![CDATA[ return $this->load->view('common/footer', $data); ]]></search>
    <add position="before"><![CDATA[
        $data['cart'] = $this->load->controller('common/cart');
        $data['offcanvas_menu'] = $this->load->controller('kreativan/offcanvas_menu');
      ]]>
    </add>
  </operation>
</file>

<!-- home controller -->
<file path="catalog/controller/common/home.php">
  <operation>
    <search><![CDATA[ $this->response->setOutput($this->load->view('common/home', $data)); ]]></search>
    <add position="before"><![CDATA[
        $data['hero'] = $this->load->controller('kreativan/hero');
      ]]>
    </add>
  </operation>
</file>

<!-- product controller -->
<file path="catalog/controller/product/product.php">
  <!-- add controlers -->
  <operation>
    <search><![CDATA[ $this->response->setOutput($this->load->view('product/product', $data)); ]]></search>
    <add position="before"><![CDATA[
        $data['product_related'] = $this->load->controller('kreativan/product_related');
        $data['product_options'] = $this->load->controller('kreativan/product_options');
        $data['product_media'] = $this->load->controller('kreativan/product_media');
        $data['product_review_form'] = $this->load->controller('kreativan/product_review_form');
        $data['product_attributes'] = $this->load->controller('kreativan/product_attributes');
        $data['product_reviews'] = $this->load->controller('kreativan/product_reviews');
      ]]>
    </add>
  </operation>
  <!-- disable loading defailt oc css/js -->
  <operation>
    <search><![CDATA[ $this->document->addScript('catalog/view/javascript/jquery/magnific/jquery.magnific-popup.min.js'); ]]></search>
    <add position="before"><![CDATA[ /* ]]></add>
  </operation>
  <operation>
    <search><![CDATA[ $this->document->addStyle('catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.css'); ]]></search>
    <add position="after"><![CDATA[ */ ]]></add>
  </operation>
</file>

<!-- compare -->
<file path="catalog/controller/product/compare.php">
  <operation>
    <search><![CDATA[ $this->response->addHeader('Content-Type: application/json'); ]]></search>
    <add position="before"><![CDATA[
        $json["count"] = isset($this->session->data['compare']) ? count($this->session->data['compare']) : 0;
      ]]>
    </add>
  </operation>
</file>

<!-- checkout / cart -->
<file path="catalog/controller/checkout/cart.php">
  <operation>
    <search><![CDATA[ $this->response->addHeader('Content-Type: application/json'); ]]></search>
    <add position="before"><![CDATA[
        $count = $this->cart->countProducts();
        $json["count"] = (int) $count;
      ]]>
    </add>
  </operation>
</file>

<!-- account / wishlist -->
<file path="catalog/controller/account/wishlist.php">
  <operation>
    <search><![CDATA[ $this->response->addHeader('Content-Type: application/json'); ]]></search>
    <add position="after"><![CDATA[
        if($this->customer->isLogged()) {
          $json["count"] = $this->model_account_wishlist->getTotalWishlist();
        }
      ]]>
    </add>
  </operation>
</file>

<!-- manufacturer -->
<file path="catalog/controller/product/manufacturer.php">
  <operation>
    <search><![CDATA[ $data['categories'][$key]['manufacturer'][] = array( ]]></search>
    <add position="before"><![CDATA[
         $this->load->model('tool/image');
      ]]>
    </add>
  </operation>
  <operation>
    <search><![CDATA[ $data['categories'][$key]['manufacturer'][] = array( ]]></search>
    <add position="after"><![CDATA[
        "image" => $this->model_tool_image->resize($result["image"], 80, 80),
      ]]>
    </add>
  </operation>
</file>

<!-- checkout controller -->
<file path="catalog/controller/checkout/checkout.php">
   <!-- disable loading defailt oc css/js -->
  <operation>
    <search><![CDATA[ $this->document->addScript('catalog/view/javascript/jquery/datetimepicker/moment/moment.min.js'); ]]></search>
    <add position="before"><![CDATA[ /* ]]></add>
  </operation>
  <operation>
    <search><![CDATA[ $this->document->addStyle('catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.css'); ]]></search>
    <add position="after"><![CDATA[ */ ]]></add>
  </operation>
</file>

<!-- affiliate controller -->
<file path="catalog/controller/affiliate/register.php">
   <!-- disable loading defailt oc css/js -->
  <operation>
    <search><![CDATA[ $this->document->addScript('catalog/view/javascript/jquery/datetimepicker/moment/moment.min.js'); ]]></search>
    <add position="before"><![CDATA[ /* ]]></add>
  </operation>
  <operation>
    <search><![CDATA[ $this->document->addStyle('catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.css'); ]]></search>
    <add position="after"><![CDATA[ */ ]]></add>
  </operation>
</file>

<!-- returns -->
<file path="catalog/controller/account/return.php">
  <operation>
    <search><![CDATA[ $this->document->addScript('catalog/view/javascript/jquery/datetimepicker/moment/moment.min.js'); ]]></search>
    <add position="before"><![CDATA[ /* ]]></add>
  </operation>
  <operation>
    <search><![CDATA[ $this->document->addStyle('catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.css'); ]]></search>
    <add position="after"><![CDATA[ */ ]]></add>
  </operation>
</file>

<!-- module / banner -->
<file path="catalog/controller/extension/module/banner.php">
  <operation>
    <search><![CDATA[ $this->document->addStyle('catalog/view/javascript/jquery/swiper/css/swiper.min.css'); ]]></search>
    <add position="before"><![CDATA[ /* ]]></add>
  </operation>
  <operation>
    <search><![CDATA[ $this->document->addScript('catalog/view/javascript/jquery/swiper/js/swiper.jquery.js'); ]]></search>
    <add position="after"><![CDATA[ */ ]]></add>
  </operation>
</file>

<!-- module / carousel -->
<file path="catalog/controller/extension/module/carousel.php">
  <operation>
    <search><![CDATA[ $this->document->addStyle('catalog/view/javascript/jquery/swiper/css/swiper.min.css'); ]]></search>
    <add position="before"><![CDATA[ /* ]]></add>
  </operation>
  <operation>
    <search><![CDATA[ $this->document->addScript('catalog/view/javascript/jquery/swiper/js/swiper.jquery.js'); ]]></search>
    <add position="after"><![CDATA[ */ ]]></add>
  </operation>
</file>

<!-- module / information -->
<file path="catalog/controller/extension/module/information.php">
  <operation>
    <search><![CDATA[ $data['informations'][] = array( ]]></search>
    <add position="after"><![CDATA[
        'id' => $result['information_id'],
      ]]>
    </add>
  </operation>
  <operation>
    <search><![CDATA[ return $this->load->view('extension/module/information', $data); ]]></search>
    <add position="before"><![CDATA[
        $data['page_id'] = isset($_GET['information_id']) ? $_GET['information_id'] : false;
      ]]>
    </add>
  </operation>
</file>

<!-- module / slideshow -->
<file path="catalog/controller/extension/module/slideshow.php">
  <operation>
    <search><![CDATA[ $this->document->addStyle('catalog/view/javascript/jquery/swiper/css/swiper.min.css'); ]]></search>
    <add position="before"><![CDATA[ /* ]]></add>
  </operation>
  <operation>
    <search><![CDATA[ $this->document->addScript('catalog/view/javascript/jquery/swiper/js/swiper.jquery.js'); ]]></search>
    <add position="after"><![CDATA[ */ ]]></add>
  </operation>
</file>

<!-- CUSTOM IMAGE CROP FUNCTION / METHOD -->
<file path="system/library/image.php">
  <operation>
    <search><![CDATA[ private function html2rgb($color) { ]]></search>
      <add position="before"><![CDATA[

        public function cropImage(int $width = 0, int $height = 0, $default = '') {
          if (!$this->width || !$this->height) return;

          $xpos = 0;
          $ypos = 0;

          $new_width = (int)($this->width);
          $new_height = (int)($this->height);
          $xpos = (int)(($width - $new_width) / 2);
          $ypos = (int)(($height - $new_height) / 2);

          $image_old = $this->image;
          $this->image = imagecreatetruecolor($width, $height);

          if ($this->mime == 'image/png') {
            imagealphablending($this->image, false);
            imagesavealpha($this->image, true);

            $background = imagecolorallocatealpha($this->image, 255, 255, 255, 127);

            imagecolortransparent($this->image, $background);

          } else if ($this->mime == 'image/webp') {
            imagealphablending($this->image, false);
            imagesavealpha($this->image, true);

            $background = imagecolorallocatealpha($this->image, 255, 255, 255, 127);

            imagecolortransparent($this->image, $background);
          } else {
            $background = imagecolorallocate($this->image, 255, 255, 255);
          }

          imagefilledrectangle($this->image, 0, 0, $width, $height, $background);

          imagecopyresampled($this->image, $image_old, $xpos, $ypos, 0, 0, $new_width, $new_height, $this->width, $this->height);
          imagedestroy($image_old);

          $this->width = $width;
          $this->height = $height;
        }

      ]]>
    </add>
  </operation>
</file>

</modification>